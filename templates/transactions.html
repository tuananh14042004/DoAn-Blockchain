<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao Dá»‹ch Blockchain</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body>
    
    <header class="text-center p-3 bg-light">
        <h1>ğŸš€ Giao Dá»‹ch Blockchain</h1>
        <a href="{{ url_for('home') }}" class="btn btn-secondary">ğŸ  Trang chá»§</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª ÄÄƒng xuáº¥t</a>
    </header>

    <div class="container mt-4">
        <h2 class="text-center">ğŸ”— Blockchain Demo</h2>

        <!-- Form ThÃªm Giao Dá»‹ch -->
        <div class="transaction-form mt-4">
            <h3>ğŸ“© ThÃªm giao dá»‹ch</h3>
            <input type="text" id="sender" class="form-control" placeholder="NgÆ°á»i gá»­i">
            <input type="text" id="receiver" class="form-control mt-2" placeholder="NgÆ°á»i nháº­n">
            <input type="number" id="amount" class="form-control mt-2" placeholder="Sá»‘ tiá»n">
            <button id="addTransaction" class="btn btn-success mt-2">ğŸ’° Gá»­i giao dá»‹ch</button>
        </div>

        <!-- CÃ¡c nÃºt thao tÃ¡c -->
        <div class="buttons mt-4">
            <button id="mineBlock" class="btn btn-primary">â›ï¸ ÄÃ o Block</button>
            <button id="viewBlockchain" class="btn btn-secondary">ğŸ“œ Xem Blockchain</button>
        </div>

        <!-- Hiá»ƒn thá»‹ Blockchain -->
        <div class="blockchain-container mt-4">
            <h3>ğŸ”— Blockchain:</h3>
            <pre id="blockchainData" class="bg-light p-3 border">ChÆ°a cÃ³ dá»¯ liá»‡u...</pre>
        </div>

        <!-- Hiá»ƒn thá»‹ Lá»‹ch sá»­ giao dá»‹ch -->
        <div class="transaction-list mt-4">
            <h3>ğŸ“œ Lá»‹ch sá»­ giao dá»‹ch</h3>
            <button id="viewTransactions" class="btn btn-info">ğŸ“Œ Xem giao dá»‹ch</button>
            <table class="table table-bordered mt-2">
                <thead>
                    <tr>
                        <th>NgÆ°á»i Gá»­i</th>
                        <th>NgÆ°á»i Nháº­n</th>
                        <th>Sá»‘ Tiá»n</th>
                    </tr>
                </thead>
                <tbody id="transactionTable">
                    <tr><td colspan="3">ChÆ°a cÃ³ giao dá»‹ch...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Script xá»­ lÃ½ giao diá»‡n -->
    <script>
        // ğŸ›‘ Kiá»ƒm tra Ä‘Äƒng nháº­p trÆ°á»›c khi táº£i trang
        fetch("/transactions", { credentials: "include" })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url; // Chuyá»ƒn hÆ°á»›ng náº¿u bá»‹ logout
                }
            })
            .catch(error => console.error("Lá»—i:", error));

        // âœ… Gá»­i giao dá»‹ch má»›i
        document.getElementById("addTransaction").addEventListener("click", function() {
            const sender = document.getElementById("sender").value.trim();
            const receiver = document.getElementById("receiver").value.trim();
            const amount = document.getElementById("amount").value.trim();

            if (!sender || !receiver || !amount || isNaN(amount) || amount <= 0) {
                alert("â›” Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ vÃ  há»£p lá»‡ thÃ´ng tin giao dá»‹ch!");
                return;
            }

            fetch("/add_transaction", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ sender, receiver, amount })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchTransactions(); // ğŸ†• Cáº­p nháº­t danh sÃ¡ch giao dá»‹ch ngay sau khi thÃªm
            })
            .catch(error => console.error("Lá»—i:", error));
        });

        // ğŸ“Œ Xem Blockchain
        document.getElementById("viewBlockchain").addEventListener("click", function() {
            fetch("/get_chain", { method: "GET", credentials: "include" })
            .then(response => response.json())
            .then(data => {
                document.getElementById("blockchainData").textContent = JSON.stringify(data.chain, null, 2);
            })
            .catch(error => console.error("Lá»—i:", error));
        });

        // â›ï¸ ÄÃ o Block
        document.getElementById("mineBlock").addEventListener("click", function() {
            fetch("/mine_block", { method: "GET", credentials: "include" })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchTransactions(); // ğŸ†• Cáº­p nháº­t láº¡i danh sÃ¡ch giao dá»‹ch sau khi Ä‘Ã o block
                document.getElementById("blockchainData").textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => alert("Lá»—i Ä‘Ã o block: " + error.message));
        });

        // ğŸ“œ Xem lá»‹ch sá»­ giao dá»‹ch
        function fetchTransactions() {
            fetch('/get_transactions')
            .then(response => response.json())
            .then(data => {
                let tableBody = document.getElementById("transactionTable");
                tableBody.innerHTML = ""; // XÃ³a ná»™i dung cÅ©

                if (!data.transactions || data.transactions.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='3'>âš ï¸ KhÃ´ng cÃ³ giao dá»‹ch nÃ o!</td></tr>";
                    return;
                }

                data.transactions.forEach(tx => {
                    let row = `<tr>
                        <td>${tx.sender}</td>
                        <td>${tx.receiver}</td>
                        <td>${tx.amount}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => console.error("Lá»—i táº£i giao dá»‹ch:", error));
        }

        // ğŸ”„ Tá»± Ä‘á»™ng táº£i lá»‹ch sá»­ giao dá»‹ch khi trang má»Ÿ
        document.getElementById("viewTransactions").addEventListener("click", fetchTransactions);
        fetchTransactions();
    </script>    
</body>
</html>
